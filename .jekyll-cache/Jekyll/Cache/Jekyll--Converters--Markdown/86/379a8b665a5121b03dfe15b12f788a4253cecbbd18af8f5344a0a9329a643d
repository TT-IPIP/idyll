I"ú<p>The recent release of Cowboy 2.4.0 fixes the last bug I am aware of in its H2 implementation. When Phoenix 1.4 is
released it will include alpha support for Cowboy 2 and thus HTTP/2 (or H2 for short).</p>

<p>I‚Äôve been testing it for a while and one of the hardest things to get working was push (aka PUSH_PROMISE) support in H2.</p>

<p>Server push or push promise is when the server sends a client instructions to download files it knows the client will
need. The client can then receive the files before parsing the page so that they are already available in the cache.</p>

<p>Push has been supported by Cowboy for a while but I couldn‚Äôt get it working. I tried a lot of different stuff (thats a
whole other blog post) and finally I reached out to Jake Archibald from Google who pointed out that Chrome likely wasn‚Äôt
trusting my ‚Äúsnake oil‚Äù certificate.</p>

<p>It turns out that even if you tell Chrome to accept your cert, you need to trust a cert with proper SAN support to
get PUSH_PROMISE to work - <em>even when working off localhost</em>.</p>

<p><strong>Simply put, you need to use SAN or push doesn‚Äôt work.</strong></p>

<p>So I‚Äôve put together instructions on how to setup your own self-signed certs with SAN support.</p>

<h3 id="self-signed-certs-with-san-using-openssl">Self-Signed Certs with SAN using OpenSSL</h3>

<p>Before you get started, I want to point out that I am using <code class="language-plaintext highlighter-rouge">test.phx.sh</code> as my DNS name for my app. <code class="language-plaintext highlighter-rouge">phx.sh</code>, <code class="language-plaintext highlighter-rouge">*.phx.sh</code>
and <code class="language-plaintext highlighter-rouge">*.dev.phx.sh</code> have all be setup to point to 127.0.0.1 to simplify development when using certs. So you can just
change <code class="language-plaintext highlighter-rouge">test.phx.sh</code> to <code class="language-plaintext highlighter-rouge">your-app.phx.sh</code> and it should just work for your app.</p>

<p>You need to setup a config file for openssl as it needs the config file to read in the SAN.
Here‚Äôs an example, let‚Äôs call it <code class="language-plaintext highlighter-rouge">phx.sh.cnf</code>:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">[</span>req]
default_bits <span class="o">=</span> 4096
prompt <span class="o">=</span> no
default_md <span class="o">=</span> sha256
x509_extensions <span class="o">=</span> v3_req
distinguished_name <span class="o">=</span> dn

<span class="o">[</span>dn]
C <span class="o">=</span> EX
ST <span class="o">=</span> Elixir
L <span class="o">=</span> Phoenix
O <span class="o">=</span> App
emailAddress <span class="o">=</span> email@phx.sh
CN <span class="o">=</span> test.phx.sh

<span class="o">[</span>v3_req]
subjectAltName <span class="o">=</span> @alt_names

<span class="o">[</span>alt_names]
DNS.1 <span class="o">=</span> test.phx.sh
DNS.2 <span class="o">=</span> <span class="k">*</span>.phx.sh</code></pre></figure>

<p><em>I‚Äôd like to point out that your OS probably has a very specific openssl.cnf file that you should base any production
certs on. On macOS you will find it in <code class="language-plaintext highlighter-rouge">/System/Library/OpenSSL</code> and it contains pretty specific config that you
should be using. This is only intended for your dev environment.</em></p>

<p>With that file in place you can simply run openssl to generate a key and cert in one swoop.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">openssl req <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-newkey</span> rsa:2048 <span class="nt">-sha256</span> <span class="nt">-nodes</span> <span class="nt">-keyout</span> phx.sh.key <span class="nt">-days</span> 3560 <span class="nt">-out</span> phx.sh.crt <span class="nt">-config</span> phx.sh.cnf</code></pre></figure>

<p>You can use the <em>key</em> and <em>crt</em> in your Cowboy config and this gets you started.</p>

<p>The next step is marking the cert as trusted. Double-clicking on the <code class="language-plaintext highlighter-rouge">.crt</code> file should open <em>Keychain Access</em> where you
can mark the certificate as trusted. Open it up and there‚Äôs a dropdown where you can change the trust settings. (See
above of for a picture of it.)</p>

<p>This will mark the cert as trusted for Safari. You may still get a warning in Chrome but PUSH_PROMISE will now work.</p>
:ET